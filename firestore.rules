rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isVerifiedEdu() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isVerifiedEdu == true;
    }
    
    // Users collection
    match /users/{userId} {
      // Anyone authenticated can read user profiles
      allow read: if isAuthenticated();
      
      // Users can create their own document with required fields
      allow create: if request.auth != null && 
                       request.auth.uid == userId &&
                       request.resource.data.uid == userId &&
                       request.resource.data.email is string &&
                       request.resource.data.firstName is string &&
                       request.resource.data.lastName is string &&
                       request.resource.data.displayName is string &&
                       request.resource.data.gender is string &&
                       request.resource.data.major is string &&
                       request.resource.data.universityId is string &&
                       request.resource.data.isVerifiedEdu == true &&
                       request.resource.data.createdAt is timestamp;
      
      // Users can only update their own document
      allow update: if isOwner(userId);
      
      // Users can delete their own document
      allow delete: if isOwner(userId);
    }
    
    // Universities collection (read-only for clients)
    match /universities/{universityId} {
      allow read: if true; // Public read access
      allow write: if false; // Only admin SDK can write
    }
    
    // Products collection
    match /products/{productId} {
      // Anyone authenticated can read products
      allow read: if isAuthenticated();
      
      // Only verified .edu users can create products
      allow create: if isVerifiedEdu() &&
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.name is string &&
                       request.resource.data.details is string &&
                       request.resource.data.brand is string &&
                       request.resource.data.ageInMonths is int &&
                       request.resource.data.condition is string &&
                       request.resource.data.price is number &&
                       request.resource.data.price > 0 &&
                       request.resource.data.imageUrls is list &&
                       request.resource.data.imageUrls.size() >= 1 &&
                       request.resource.data.imageUrls.size() <= 3 &&
                       request.resource.data.createdAt is timestamp &&
                       request.resource.data.updatedAt is timestamp;
      
      // Owner can update their products, OR users involved in a trade can mark products as traded
      allow update: if (isOwner(resource.data.userId) &&
                        request.resource.data.userId == resource.data.userId) ||
                       // Allow marking as traded if user is trading partner
                       (isAuthenticated() &&
                        request.resource.data.isTraded == true &&
                        request.resource.data.tradedWith == request.auth.uid);
      
      // Only owner can delete their products
      allow delete: if isOwner(resource.data.userId);
    }
    
    // Chats collection
    match /chats/{chatId} {
      // Users can read chats they're part of
      allow read: if isAuthenticated() &&
                     request.auth.uid in resource.data.participantIds;
      
      // Only verified users can create chats
      allow create: if isVerifiedEdu() &&
                       request.auth.uid in request.resource.data.participantIds &&
                       request.resource.data.participantIds.size() == 2;
      
      // Participants can update chat (for messages, last read, etc.)
      allow update: if isAuthenticated() &&
                       request.auth.uid in resource.data.participantIds &&
                       // Prevent changing participants
                       request.resource.data.participantIds == resource.data.participantIds;
      
      // Messages subcollection
      match /messages/{messageId} {
        allow read: if isAuthenticated() &&
                       request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participantIds;
        
        allow create: if isAuthenticated() &&
                         request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participantIds &&
                         (request.resource.data.senderId == request.auth.uid ||
                          request.resource.data.senderId == 'system');
      }
    }
    
    // Trades collection
    match /trades/{tradeId} {
      // Users can read trades they're involved in
      allow read: if isAuthenticated() &&
                     (request.auth.uid == resource.data.initiatorUserId ||
                      request.auth.uid == resource.data.recipientUserId);
      
      // Only verified users can create trades
      allow create: if isVerifiedEdu() &&
                       (request.auth.uid == request.resource.data.initiatorUserId ||
                        request.auth.uid == request.resource.data.recipientUserId);
      
      // Participants can update trade status and negotiation fields
      // Allow updating: negotiationStatus, completionRequestedBy, agreedAmount,
      // status, isPaid, completedAt, paymentType, nessieTransferId, 
      // sustainabilityImpact, updatedAt, initiatorConfirmed, recipientConfirmed
      allow update: if isAuthenticated() &&
                       (request.auth.uid == resource.data.initiatorUserId ||
                        request.auth.uid == resource.data.recipientUserId) &&
                       // Cannot change core trade participants or products
                       request.resource.data.initiatorUserId == resource.data.initiatorUserId &&
                       request.resource.data.recipientUserId == resource.data.recipientUserId &&
                       request.resource.data.chatId == resource.data.chatId;
      
      // No deletion allowed (keep trade history)
      allow delete: if false;
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      // Users can only read their own notifications
      allow read: if isAuthenticated() &&
                     request.auth.uid == resource.data.userId;
      
      // Anyone can create notifications (system, other users)
      allow create: if isAuthenticated();
      
      // Users can update their own notifications (mark as read)
      allow update: if isAuthenticated() &&
                       request.auth.uid == resource.data.userId &&
                       // Can only change isRead field
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead']);
      
      // Users can delete their own notifications
      allow delete: if isAuthenticated() &&
                       request.auth.uid == resource.data.userId;
    }
    
    // Email OTPs collection (server-side only)
    match /emailOtps/{otpId} {
      allow read, write: if false; // Only Cloud Functions can access
    }
    
    // Debug OTPs collection (for development/testing)
    match /emailOtpsDebug/{email} {
      allow read: if true; // Allow reading for testing
      allow write: if true; // Allow writes in development mode (TODO: restrict in production)
    }
    
    // Transactions collection (Capital One Nessie payments)
    match /transactions/{transactionId} {
      // Users can read transactions they're involved in (as payer or payee)
      allow read: if isAuthenticated() &&
                     (request.auth.uid == resource.data.payerUserId ||
                      request.auth.uid == resource.data.payeeUserId);
      
      // Only verified users involved in the trade can create transactions
      allow create: if isVerifiedEdu() &&
                       (request.auth.uid == request.resource.data.payerUserId ||
                        request.auth.uid == request.resource.data.payeeUserId) &&
                       request.resource.data.tradeId is string &&
                       request.resource.data.amount is number &&
                       request.resource.data.amount > 0 &&
                       request.resource.data.paymentMethod in ['nessie', 'pay_at_exchange', 'direct_swap'] &&
                       request.resource.data.status in ['pending', 'processing', 'completed', 'failed'] &&
                       request.resource.data.createdAt is timestamp;
      
      // Users involved can update transaction status (for payment confirmation)
      allow update: if isAuthenticated() &&
                       (request.auth.uid == resource.data.payerUserId ||
                        request.auth.uid == resource.data.payeeUserId) &&
                       // Cannot change core fields, only status and completion metadata
                       request.resource.data.tradeId == resource.data.tradeId &&
                       request.resource.data.payerUserId == resource.data.payerUserId &&
                       request.resource.data.payeeUserId == resource.data.payeeUserId &&
                       request.resource.data.amount == resource.data.amount;
      
      // No deletion allowed (keep transaction history for auditing)
      allow delete: if false;
    }
    
    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

